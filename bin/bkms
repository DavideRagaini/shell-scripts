#!/usr/bin/env sh

DMENU_ENABLE=0
BKMS_FILE="${XDG_CONFIG_HOME:-$HOME/.config}/qutebrowser/bookmarks/urls"

save() {
    if [ $DMENU_ENABLE -eq 0 ]; then
        echo "Title: "
        read -r TITLE
        echo "URL: "
        read -r URL
    else
        TITLE="$(echo | dmenu_def -p 'Bookmark TITLE: ')" ||
            exit
        URL="$(echo | dmenu_def -p 'Bookmark URL: ')" ||
            exit
    fi
    printf "%s %s\n" "$URL" "$TITLE" >>"$BKMS_FILE"
    exit
}

select_bkms() {
    if [ $DMENU_ENABLE -eq 0 ]; then
        DESCRIPTION="$(fzf <"$BKMS_FILE")"
    else
        DESCRIPTION="$(dmenu_def -l 10 -i -p 'Select Bookmark: ' <"$BKMS_FILE")" ||
            exit
    fi
    LINK="$(grep "$DESCRIPTION" "$BKMS_FILE" | cut -d' ' -f1)"
    [ "$(echo "$LINK" | wc -l)" -gt 1 ] &&
        echo "Nothing selected. Exiting" &&
        return
    setsid -f "$BROWSER" "$LINK" >/dev/null 2>&1 &
}

help() {
    cat <<EOF
bkms HELP

Usage: bkms ...
where:
    d) DMENU_ENABLE=1 ;; # Defaults to fzf
    s) save ;;
    u) URL="$OPTARG" ;;
    h) help ;;
EOF
    exit 0
}

while getopts "bdhst:u:" arg; do
    case "$arg" in
        d) DMENU_ENABLE=1 ;;
        s) save ;;
        u) TITLE="$OPTARG" ;;
        u) URL="$OPTARG" ;;
        h | *) help ;;
    esac
done
select_bkms
