#!/bin/sh

if [ -z "$1" ]; then
	CMDS="\
queue
enqueue
enqueue&play
lectures
add_playlist
local
last
last_lecture
aplay
edit_queue"

	CHOSEN="$(echo "$CMDS" | dmenu -l 10)" || exit
else
	CHOSEN="$1"
fi

VIDEOS_FOLDER="${XDG_CONFIG_HOME:-$HOME/Storage/Videos}"
PATH_QUEUE="$HOME/.config/mpv/queue"
PATH_LAST="$HOME/.config/mpv/last"

[ -n "$2" ] &&
	printf "%s" "$2" | grep -Eo '(http|https)://[^/"]+' &&
	URL="$2" ||
	URL="$(xclip -o -selection clipboard)"

search_from() {
	URL="$(echo "$1" |
		grep -P "^$(echo "$1" |
			grep "https:" |
			sed 's/\t.*//g' |
			dmenu -i -l 20 |
			awk '{print $1}')\s" |
		sed 's/.*\t//')"
}

add_to() {
	[ -z "$3" ] && PLAYLIST=""
	echo "$1" >"$BACKUP"
	TITLE="$(youtube-dl --get-title "$URL")"
	printf "%s%s\t%s\n%s" "$PLAYLIST" "$TITLE" "$URL" "$1" >"$2" ||
		notify-send "Failed to queue"
}

save_to() {
	echo "$URL" >"$1"
}

open_mpv() {
	notify-send "Working on it" "$URL"
	mpv --geometry=256x144+1660+910 --no-terminal "$URL"
}

case "$CHOSEN" in
enqueue)
	QUEUE="$(cat "$PATH_QUEUE")"
	add_to "$QUEUE" "$PATH_QUEUE"
	;;

queue)
	QUEUE="$(cat "$PATH_QUEUE")"
	search_from "$QUEUE"
	save_to "$PATH_LAST"
	open_mpv
	;;

'enqueue&play')
	QUEUE="$(cat "$PATH_QUEUE")"
	add_to "$QUEUE" "$PATH_QUEUE"
	save_to "$PATH_LAST"
	open_mpv
	;;

add_playlist)
	PLAYLIST="$(dmenu -P -p "Name of the playlist?"):"
	QUEUE="$(cat "$PATH_QUEUE")"
	add_to "$QUEUE" "$PATH_QUEUE" "$PLAYLIST"
	;;

lectures)
	LECTURES="$VIDEOS_FOLDER/Lectures"
	CHOSEN="$(find "$LECTURES" -maxdepth 1 -type d | cut -d'/' -f7 | dmenu -i -l 20)" || exit
	URL="$LECTURES/$CHOSEN"
	save_to "$PATH_LAST"
	open_mpv
	;;

local)
	GENER="$VIDEOS_FOLDER"
	DIR=$(find "$GENER" -maxdepth 1 -type d | cut -d'/' -f6 | dmenu -i -l 20) || exit
	if [ -d "$GENER$DIR" ]; then
		CHOSEN=$(find "$GENER$DIR" | cut -d'/' -f8 | dmenu -i -l 20) || exit
		URL="$GENER$DIR/$CHOSEN"
		save_to "$PATH_LAST"
		open_mpv
	else
		URL="$GENER$DIR"
		save_to "$PATH_LAST"
		open_mpv
	fi
	;;

last)
	mpv "$(cat "$PATH_LAST")"
	;;

last_lecture)
	mpv "$VIDEOS_FOLDER"
	;;

aplay)
	save_to "$PATH_LAST"
	open_mpv
	;;

edit_queue)
	$TERMINAL -e nvim "$PATH_QUEUE"
	;;
esac
