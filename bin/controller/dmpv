#!/bin/bash

if [ -z "$1" ]; then
	CMDS="\
queue
enqueue
enqueue&play
aplay
last
edit_queue
lectures
local
last_lecture"

	CHOSEN="$(echo "$CMDS" | dmenu -l 10)" || exit
else
	CHOSEN="$1"
fi

VIDEOS_FOLDER="${XDG_CONFIG_HOME:-$HOME/Storage/Videos}"
PATH_QUEUE="$HOME/.config/mpv/queue"
PATH_LAST="$HOME/.config/mpv/last"

valid_url() {
	printf "%s" "$1" |
		grep -qEo '(http|https)://.*(youtube.com|twitch.tv|vimeo.com|youtu.be).*' ||
		notify-send "Not valid URL" "$1"
}

add_to_queue() {
	PLAYLIST="$(dmenu -P -p "Name of the playlist?")"
	[ -z "$PLAYLIST" ] && PLAYLIST="1shot"
	notify-send "$PLAYLIST" "$1"
	TITLE="$(youtube-dl --get-title "$URL")"
	printf "%s: %s\t%s\n%s" "$PLAYLIST" "$TITLE" "$1" "$(cat "$PATH_QUEUE")" >"$PATH_QUEUE" ||
		notify-send "Failed to queue"
	sort "$PATH_QUEUE" -o "$PATH_QUEUE"
}

open_mpv() {
	echo "$1" >"$PATH_LAST"
	notify-send "Working on" "$1"
	mpv --geometry=256x144+1660+910 --no-terminal "$1"
}

case "$CHOSEN" in
enqueue)
	if [ -n "$2" ] && [ -n "$(valid_url "$2")" ]; then
		URL="$2"
	else
		tmp="$(xclip -selection clipboard -o)" &&
			valid_url "$tmp" &&
			URL="$tmp"
	fi
	[ -n "$(valid_url "$URL")" ] &&
		notify-send "Something wrong!" &&
		exit
	add_to_queue "$URL"
	;;

queue)
	QUEUE="$(cat "$PATH_QUEUE")"
	URL="$(echo "$QUEUE" |
		grep -P "^$(echo "$QUEUE" |
			grep "https:" |
			sed 's/\t.*//g' |
			dmenu -i -l 20 |
			awk '{print $1}')\s" |
		sed 's/.*\t//')"
	open_mpv "$URL"
	;;

'enqueue&play')
	if [ -n "$2" ] && [ -n "$(valid_url "$2")" ]; then
		URL="$2"
	else
		tmp="$(xclip -selection clipboard -o)" &&
			valid_url "$tmp" &&
			URL="$tmp"
	fi
	[ -n "$(valid_url "$URL")" ] &&
		notify-send "Something wrong!" &&
		exit
	add_to_queue "$URL"
	open_mpv "$URL"
	;;

lectures)
	LECTURES="$VIDEOS_FOLDER/Lectures"
	CHOSEN="$(find "$LECTURES" -maxdepth 1 -type d | cut -d'/' -f7 | dmenu -i -l 20)" || exit
	URL="$LECTURES/$CHOSEN"
	open_mpv "$URL"
	;;

local)
	GENER="$VIDEOS_FOLDER"
	DIR=$(find "$GENER" -maxdepth 1 -type d | cut -d'/' -f6 | dmenu -i -l 20) || exit
	if [ -d "$GENER$DIR" ]; then
		CHOSEN=$(find "$GENER$DIR" | cut -d'/' -f8 | dmenu -i -l 20) || exit
		URL="$GENER$DIR/$CHOSEN"
		open_mpv "$URL"
	else
		URL="$GENER$DIR"
		open_mpv "$URL"
	fi
	;;

last)
	mpv "$(cat "$PATH_LAST")"
	;;

last_lecture)
	mpv "$VIDEOS_FOLDER/doing"
	;;

aplay)
	open_mpv "$2"
	;;

edit_queue)
	$TERMINAL -e nvim "$PATH_QUEUE"
	;;
esac
