#!/bin/sh

if [ -z "$1" ]
then
	cmds="\
	Lock
	dwm
	dwmblocks
	Leave
	Reboot
	Suspend
	Hibernate
	Display
	Shutdown"
	choice="$(printf "%s" "$cmds" | cut -d'	' -f 2 | dmenu -i -p 'Choose an action:')"
else
	choice="$1"
fi

log() {
	printf "%s %s%s\n" "$1" "$(date '+%F %a %T')" "$2" >> "$HOME/.local/uptime"
}

confirm() {
	[ "$(printf "No\\nYes" | dmenu -i -p "$choice" -nb darkred -sb red -sf white -nf gray)" = "Yes" ] ||
		exit 1
}

case "$choice" in
	Start) log "Start     " "" ;;
	Resume) log "Resume    " "" ;;
	dwm) kill -HUP "$(pgrep -u $USER "\bdwm$")" ;;
	dwmblocks) killall -q dwmblocks && setsid dwmblocks & ;;
	Display) xset dpms force off ;;
	Leave) kill -TERM "$(pgrep -u $USER "\bdwm$")" ;;
	Lock) confirm; lock ;;
	Shutdown)
		confirm
		log "Shutdown  " " -> $(uptime -p)" &&
			sudo -A poweroff -i now;;
	Suspend)
		confirm
		dmpc pause
		tppctl pause_all
		playerctl --all-players pause
		log "Suspend   " "" &&
			sudo -A zzz
		i3lock -eft -c 1d2021 -i ~/Storage/Pictures/lockscreen.png ;;
	Hibernate)
		confirm
		dmpc pause
		tppctl pause_all
		playerctl --all-players pause
		log "Hibernate " "" &&
			sudo -A ZZZ
		i3lock -eft -c 1d2021 -i ~/Storage/Pictures/lockscreen.png ;;
	Reboot)
		confirm
		log "Reboot    " "" &&
			sudo -A reboot -i now ;;
	*) exit 2 ;;
esac
