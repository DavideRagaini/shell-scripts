#!/bin/sh
set -x

[ -z "$1" ] && echo "Missing arguments" && exit
actions() {
    case $1 in
        toggle) echo cycle pause | socat - "$2" ;;
        play) echo '{ "command": ["set_property", "pause", false] }' | socat - "$2" ;;
        pause) echo '{ "command": ["set_property", "pause", true] }' | socat - "$2" ;;
        next) echo playlist-next | socat - "$2" ;;
        prev) echo playlist-prev | socat - "$2" ;;
        fseek) echo seek 10 | socat - "$2" ;;
        bseek) echo seek -10 | socat - "$2" ;;
    esac
}

instances="$(find "/tmp/mpvSockets" -type s)"

case "$1" in
    "pause_all")
        for i in $instances; do
            echo '{ "command": ["set_property", "pause", true] }' |
                socat - "$i"
        done
        ;;
    "invert")
        for i in $instances; do
            echo '{ "command": ["cycle", "pause"] }' |
                socat - "$i"
        done
        ;;
    "info")
        for i in $instances; do
            titles="$(echo '{ "command": ["get_property", "media-title"] }' | socat - "$i" | jq -r '.data')"
            list="$(printf "%s%s (%s)\n " "$list" "$titles" "$i")"
        done
        chosen="$(echo "$list" | sed '/^ $/d' | dmenu -i -l 5 -p "Get info from?")"
        info="$(echo "$chosen" | sed 's/.*(\(.*\))/\1/')"
        title="$(echo '{ "command": ["get_property", "media-title"] }' | socat - "$info" | jq -r '.data')"
        path="$(echo '{ "command": ["get_property", "path"] }' | socat - "$info" | jq -r '.data')"
        echo "[[$path][$title]]" | xclip -i -selection clipboard
        ;;
    *)
        if [ "$(echo "$instances" | wc -l)" -eq 1 ]; then
            actions "$1" "$instances"
        else
            list=" "
            for i in $instances; do
                titles="$(echo '{ "command": ["get_property", "media-title"] }' | socat - "$i" | jq -r '.data')"
                list="$(printf "%s%s (%s)\n " "$list" "$titles" "$i")"
            done
            chosen="$(echo "$list" | sed '/^ $/d' | dmenu -i -l 5 -p "Toggle which?")"
            actions "$1" "$(echo "$chosen" | sed 's/.*(\(.*\))/\1/')"
        fi
        ;;
esac
