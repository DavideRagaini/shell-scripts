#!/bin/sh

if [ -z "$1" ]; then
    URL="$(xclip -selection clipboard -o)"
else
    URL="$1"
fi

SOCKETS="$(find /tmp/mpvSockets -type s)"
if [ "$(echo "$SOCKETS" | wc -l)" -ge 2 ]; then
    for i in $SOCKETS; do
        PATH="$(echo '{ "command": ["get_property", "path"] }' | socat -d - "$i" | jq -r '.data')"
        if "$(echo "$PATH" | grep -q -i -v playlist)"; then
            TITLE="$(echo '{ "command": ["get_property", "media-title"] }' | socat -d - "$i" | jq -r '.data')"
            PID="$i"
            STATUS="$(echo '{ "command": ["get_property", "pause"] }' | socat -d - "$i" | jq -r '.data')"
            if [ "$STATUS" = 'true' ]; then
                STATUS=''
            elif [ "$STATUS" = 'false' ]; then
                STATUS=''
            fi
            LIST="${LIST}${TITLE}\t${PID}\n"
        fi
    done
    SOCKET="$(echo "$LIST" | dmenu -i -l 5 -p "Choose a socket" | cut -f2)" ||
        exit
    SOCKET="/tmp/mpvSockets/$SOCKET"
else
    SOCKET=$SOCKETS
fi
if [ -S "$SOCKET" ]; then
    echo "{ \"command\": [ \"loadfile\", \"$URL\", \"append-play\" ] }" |
        socat -d - "$SOCKET" >/tmp/mpvSockets/log 2>&1
else
    shift
    setsid -f mpv --no-terminal --player-operation-mode=pseudo-gui \
        --geometry=15%-5-15 --input-ipc-server="$SOCKET" "$@" "$URL"
fi

# if ! INFO="$(yt-dlp --playlist-end=1 --print "«%(uploader,channel)-25s» %(playlist_title,title)-100s" "$URL" 2>&1)"; then
#     exit
# fi
# [ "$(echo "$INFO" | wc -l)" -ge 1 ] &&
#     INFO="$(echo "$INFO" | tail -n1)"

# notify-send "Added to Queue" "$(echo "$INFO" | tr -s ' ')"
# PATH_LAST="$HOME/.config/mpv/last"
# grep -q "$INFO" "$PATH_LAST" ||
#     printf "%-14s\t%s\t%s\n%s\n" \
#         "$(date '+%k:%M %d/%m/%y')" \
#         "$INFO" \
#         "$URL" \
#         "$(cat "$PATH_LAST")" >"$PATH_LAST"
