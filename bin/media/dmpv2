#!/bin/sh

if [ -z "$1" ]; then
    URL="$(xclip -selection clipboard -o)"
else
    URL="$1"
fi
PID="$(wmctrl -lxp | awk '/ mpvFloat.mpv /{print $3}')"
if [ -n "$PID" ]; then
    echo "{ \"command\": [ \"loadfile\", \"$URL\", \"append-play\" ] }" |
        socat -d - "/tmp/mpvSockets/$PID" >/dev/null 2>&1
else
    setsid -f mpv --no-terminal --geometry=15%-5-15 --x11-name="mpvFloat" "$URL"
fi

if ! INFO="$(yt-dlp --playlist-end=1 --print "«%(uploader,channel)-25s» %(playlist_title,title)-100s" "$URL" 2>&1)"
then
    notify-send "Error Adding to Queue" "$INFO"
    exit
fi
notify-send "Added to Queue" "$(echo "$INFO" | tr -s ' ')"
PATH_LAST="$HOME/.config/mpv/last"
grep -q "$INFO" "$PATH_LAST" ||
    printf "%-14s\t%s\t%s\n%s\n" \
        "$(date '+%k:%M %d/%m/%y')" \
        "$INFO"\
        "$URL" \
        "$(cat "$PATH_LAST")" >"$PATH_LAST"
