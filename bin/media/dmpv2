#!/bin/sh

PID="$(wmctrl -lxp | awk '/ mpvFloat.mpv /{print $3}')"
if [ -n "$PID" ]; then
    echo "{ \"command\": [ \"loadfile\", \"$1\", \"append-play\" ] }" |
        socat -d - "/tmp/mpvSockets/$PID" >/dev/null 2>&1
else
    setsid -f mpv --no-terminal --geometry=15%-5-5 --x11-name="mpvFloat" "$1"
fi

if ! INFO="$(yt-dlp --playlist-end=1 --print "«%(uploader,channel)-25s» %(playlist_title,title)-100s" "$1" 2>&1)"
then
    notify-send "Error Adding to Queue" "$INFO"
    exit
fi
notify-send "Added to Queue" "$(echo "$INFO" | tr -s ' ')"
PATH_LAST="$HOME/.config/mpv/last"
grep -q "$INFO" "$PATH_LAST" ||
    printf "%-14s\t%s\t%s\n%s\n" \
        "$(date '+%k:%M %d/%m/%y')" \
        "$INFO"\
        "$1" \
        "$(cat "$PATH_LAST")" >"$PATH_LAST"
