#!/bin/sh

CACHE="$HOME/.cache/via/database"
LAST="$HOME/.cache/via/history"

build_cache() {
    # fd -c never -t f -E "Storage" -E "Projects" -E "Torrents" -E "Laboratorio Automazione" -E "Programmazione ad Oggetti" --base-directory "$HOME" >"$CACHE"
    # find "$HOME" -type f -iname "*.pdf" -not -path "./.*/*" -not -path "./Storage/*" >"$CACHE"
    locate -ri "$HOME/.*.pdf$" | sed "s@$HOME@"'~''@; /~\/\..*$/d' >"$CACHE"
    printf '' >"$LAST"
}

reader() {
    cache="$(cat "$CACHE")"
    last="$(cat "$LAST")"
    file="$(printf "%s\n------------\n%s" "$last" "$cache" | fzfmenu)"
    if [ -n "$file" ]; then
        if grep -q "$file" "$LAST"; then
            last="$(grep -v "$file" "$LAST")"
            printf "%s\n%s\n" "$file" "$last" >"$LAST"
        else
            printf "%s\n" "$file" | sort -r >>"$LAST"
        fi
        exec zathura "$file"
    fi
}

case "$1" in
    -r)
        build_cache &&
            reader
        ;;
    -ro)
        build_cache
        ;;
    *)
        reader
        ;;
esac
