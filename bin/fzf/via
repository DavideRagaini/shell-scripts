#!/bin/bash

DIR="$HOME/.cache/via"
CACHE="$DIR/database"
LAST="$DIR/history"
FMENU='fmenu -B'

build_cache_all() {
    locate -ri "$HOME/.*$" >"$CACHE-all"
    printf '' >"$LAST-all"
}

open_all(){
    cache="$(cat "$CACHE-all")"
    last="$(cat "$LAST-all")"
    file="$(printf "%s\n------------\n%s" "$last" "$cache" | $FMENU)"
    [ -z "$file" ] && exit
    exec opener "$file"
}

build_cache_docs() {
    locate -ri "$HOME/.*.pdf$" | sed "s@$HOME@"'~''@; /~\/\..*$/d' >"$CACHE-docs"
    printf '' >"$LAST-docs"
}

open_docs() {
    cache="$(cat "$CACHE-docs")"
    last="$(cat "$LAST-docs")"
    file="$(printf "%s\n------------\n%s" "$last" "$cache" | $FMENU)"
    if [ -n "$file" ]; then
        if grep -q "$file" "$LAST-docs"; then
            last="$(grep -v "$file" "$LAST-docs")"
            printf "%s\n%s\n" "$file" "$last" >"$LAST-docs"
        else
            printf "%s\n" "$file" | sort -r >>"$LAST-docs"
        fi
    else
        exit
    fi
    exec zathura "$file"
}

search() {
    fzf <<< "$(locate -ri "$HOME/.*$1.*")"
    exec opener "$file"
}

case "$1" in
    -D) build_cache_all ;;
    -d) build_cache_docs ;;
    -A) build_cache_all && open_all ;;
    -R) build_cache_docs && reader ;;
    -a) open_all ;;
    -e) search "$2" ;;
    -r) open_docs ;;
     *) open_all ;;
esac
