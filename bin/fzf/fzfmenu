#!/bin/bash

# fzfmenu - fzf as dmenu replacement
# fifos are here to not wait for end of input
# (useful for e.g. find $HOME | fzfmenu ...)
input=$(mktemp -u --suffix .fzfmenu.input)
output=$(mktemp -u --suffix .fzfmenu.output)
mkfifo "$input"
mkfifo "$output"
chmod 600 "$input" "$output"

# it's better to use st here (starts a lot faster than pretty much everything else)
# the ugly printf | sed thing is here to make args with quotes work.
# (e.g. --preview='echo {1}').
# sadly we can't use "$@" here directly because we are inside sh -c "..." call
# already.
# you can also set window dimensions via -g '=COLSxROWS', see man st.
center=0

min_dx=37
mod_x=33
min_dy=71
mod_y=67
padding=1

dim_screen="$(xrandr | awk '/current/ {sub(",","",$10); print $8$9$10}')"
dim_mon_x=$(echo "$dim_screen" | cut -d'x' -f1)
dim_mon_y=$(echo "$dim_screen" | cut -d'x' -f2)

dim_w_x=$((1 + dim_mon_x - min_dx))
dim_w_y=$((1 + dim_mon_y - min_dy))

rows=$((padding + (dim_w_x / mod_x)))
colums=$((padding + (dim_w_y / mod_y)))

if [ $center == 1 ]; then
	mx=0.75
	my=0.5

	dim_p_x=$(bc <<<"($rows * $mx)/1")
	dim_p_y=$(bc <<<"($colums * $my)/1")

	pos_x=$(bc <<<"(($dim_mon_x - $dim_w_x * $mx) / 2 ) / 1")
	pos_y=$(bc <<<"(($dim_mon_y - $dim_w_y * $my) / 2 ) / 1")

	GEOM="$(printf "%dx%d+%d+%d" "$dim_p_x" "$dim_p_y" "$pos_x" "$pos_y")"
else
	GEOM="$(printf "%dx%d" "$rows" "$((1 + colums / 2))")"
fi

# alacritty --class 'fzfmenu' --config-file="$HOME/.config/alacritty/fzfmenu.yml" -e sh -c "cat $input |
st -n fzfmenu -f "FiraCode Nerd Font Mono:size=20" -g "$GEOM" -e sh -c "cat $input |
	fzf --border=rounded --margin=1% --multi --ansi -i --height=40 $(printf -- " '%s'" "$@" | sed "s/^ ''$//") |
	tee $output" &
disown

# handle ctrl+c outside child terminal window
trap "kill '$!' 2>/dev/null; rm -f '$input' '$output'" EXIT

cat >"$input"
cat "$output"
